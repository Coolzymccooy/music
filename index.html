<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tiwaton - Sonic Magic Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FIREBASE SDKs (v8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Outfit:wght@800&display=swap');

        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #0f172a;
            color: white;
            overflow-x: hidden;
            touch-action: manipulation;
            margin: 0;
        }

        ::-webkit-scrollbar { width: 0px; background: transparent; }

        .hidden-visually {
            opacity: 0;
            pointer-events: none;
            position: absolute;
            inset: 0;
            z-index: -1;
        }

        /* --- LANDING PAGE --- */
        #landing-page {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: radial-gradient(circle at center, #2e1065 0%, #020617 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.6s ease-in-out;
        }
        
        .hero-title {
            font-family: 'Outfit', sans-serif;
            font-size: clamp(4rem, 15vw, 8rem);
            font-weight: 900;
            text-align: center;
            line-height: 0.9;
            background: linear-gradient(to bottom right, #f472b6, #a78bfa, #22d3ee);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 50px rgba(167, 139, 250, 0.3);
            margin-bottom: 2rem;
            animation: heroFloat 5s ease-in-out infinite;
        }

        .subtitle-hero {
            font-family: 'Fredoka', sans-serif;
            font-size: clamp(1.2rem, 4vw, 2.5rem);
            letter-spacing: 0.1em;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 1rem;
            display: block;
            text-transform: uppercase;
            -webkit-text-fill-color: white; 
        }

        .note-particle {
            position: absolute;
            color: rgba(255,255,255,0.2);
            font-size: 2rem;
            animation: floatUp linear infinite;
        }

        @keyframes floatUp {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            20% { opacity: 0.8; }
            100% { transform: translateY(-20vh) rotate(360deg); opacity: 0; }
        }

        @keyframes heroFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        /* --- UI COMPONENTS --- */
        .glass-panel {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        }

        .mixer-panel {
            border: 1px solid rgba(250, 204, 21, 0.3);
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
        }
        
        .tuner-panel {
            background: linear-gradient(135deg, #4c1d95 0%, #2563eb 100%);
            border: 1px solid #a78bfa;
        }

        .btn-modern {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .btn-modern:active { transform: scale(0.96); }

        .pad-btn {
            transition: all 0.1s;
            position: relative;
            overflow: hidden;
            border-radius: 16px;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            touch-action: none; /* Prevents scroll while drumming */
        }

        .pad-btn:active, .pad-btn.active {
            transform: scale(0.95);
            filter: brightness(1.3);
            box-shadow: 0 0 15px currentColor;
        }

        .recording-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .effect-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .effect-btn.selected, .nav-btn.active, .voice-btn.selected {
            background-color: #facc15; 
            color: #000;
            border-color: #facc15;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(250, 204, 21, 0.4);
            font-weight: 800;
        }
        
        .pro-tuner-btn.selected {
            background: linear-gradient(90deg, #ec4899, #8b5cf6);
            color: white;
            border: 1px solid white;
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.6);
        }

        .loop-active {
            background-color: #4f46e5;
            border-color: #818cf8;
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.5);
        }

        canvas {
            border-radius: 16px;
            width: 100%;
            background: #020617;
        }

        .view-section { display: none; }
        .view-section.active { display: flex; flex-direction: column; gap: 1rem; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- NAV DOCK --- */
        .nav-dock {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.15);
            padding: 5px;
            border-radius: 99px;
            display: flex;
            gap: 4px;
            z-index: 999;
            box-shadow: 0 10px 40px rgba(0,0,0,0.7);
            width: 96%;
            max-width: 600px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            justify-content: space-between;
        }
        .nav-dock::-webkit-scrollbar { display: none; }
        
        .nav-btn {
            padding: 10px 12px;
            border-radius: 99px;
            color: #94a3b8;
            font-weight: 700;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 0.75rem;
            white-space: nowrap;
            flex: 1;
            min-width: fit-content;
        }
        .nav-btn:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-btn.active { color: black; background-color: #facc15; box-shadow: 0 2px 10px rgba(250, 204, 21, 0.3); transform: scale(1.02); }

        @media (min-width: 768px) {
            .nav-dock { width: auto; bottom: 25px; padding: 8px; gap: 8px; justify-content: center; }
            .nav-btn { padding: 12px 24px; font-size: 0.9rem; flex: initial; }
        }

        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: #ffffff; cursor: pointer; margin-top: -7px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: rgba(255,255,255,0.2); border-radius: 2px; }
        
        .karaoke-word { transition: color 0.2s, transform 0.2s; display: inline-block; margin-right: 6px; line-height: 1.4; }
        .karaoke-active { color: #facc15; transform: scale(1.1); text-shadow: 0 0 15px #facc15; }
        .game-flash { filter: brightness(2) contrast(1.2); transform: scale(1.05); box-shadow: 0 0 30px currentColor; z-index: 10; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <!-- LANDING PAGE -->
    <div id="landing-page">
        <div id="particles-container"></div>
        <h1 class="hero-title">
            Tiwaton
            <span class="subtitle-hero">Sonic Magic Studio</span>
        </h1>
        <p class="text-lg md:text-xl text-purple-200 mb-8 max-w-md text-center px-6">Where Stories Become Songs & Beats Come to Life!</p>
        <button id="enter-btn" class="group relative px-10 py-5 bg-white rounded-full text-xl md:text-2xl font-bold text-indigo-900 shadow-[0_0_40px_rgba(255,255,255,0.4)] hover:scale-105 transition-transform overflow-hidden">
            <span class="relative z-10">‚ú® Enter Studio</span>
            <div class="absolute inset-0 bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-500 opacity-0 group-hover:opacity-20 transition-opacity"></div>
        </button>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app-container" class="w-full max-w-5xl px-3 md:px-6 mt-4 flex-grow hidden pb-28">
        
        <!-- HEADER -->
        <div class="flex justify-between items-center mb-5 px-1">
            <div class="flex items-center gap-3">
                <button id="exit-btn" class="btn-modern bg-slate-800 hover:bg-slate-700 px-3 py-2 text-lg shadow-lg border-slate-600" title="Return Home">
                    üè†
                </button>
                <h1 class="text-xl md:text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500 hidden xs:block">Tiwaton</h1>
            </div>
            
            <div id="user-profile" class="flex items-center gap-2 bg-slate-800/80 px-4 py-2 rounded-full text-xs font-semibold border border-slate-700 shadow-md">
                <span>üë§ Creator</span>
                <span class="text-green-400 animate-pulse">‚óè</span>
            </div>
        </div>

        <!-- VIEW: STUDIO -->
        <div id="view-studio" class="view-section active">
            <!-- Header & Visualizer -->
            <div class="glass-panel p-4 flex flex-col gap-3">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-bold text-yellow-400 flex items-center gap-2">‚ö° Visualizer</h2>
                    <span id="status-indicator" class="text-[10px] md:text-xs uppercase tracking-wider font-bold bg-slate-700/50 px-3 py-1 rounded-full text-slate-300 border border-slate-600">Ready</span>
                </div>
                <canvas id="visualizer" class="h-24 md:h-32 w-full"></canvas>
            </div>

            <!-- Beat Maker -->
            <div class="glass-panel p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-cyan-400">üéπ Beat Maker</h2>
                    <button id="clear-beats-btn" class="btn-modern text-xs bg-slate-700/50 hover:bg-red-500/20 hover:text-red-400 hover:border-red-500/50 px-3 py-1.5 transition-colors">Clear Pattern</button>
                </div>
                <div class="grid grid-cols-5 gap-2" id="pad-container">
                    <!-- Pads injected by JS -->
                </div>
            </div>

            <!-- Voice & Effects -->
            <div class="glass-panel p-5">
                <h2 class="text-xl font-bold mb-4 text-pink-500">üé§ Voice Magic</h2>
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex flex-col gap-4 items-center justify-center flex-shrink-0 md:w-1/3">
                        <button id="record-btn" class="w-20 h-20 md:w-24 md:h-24 rounded-full bg-slate-700 border-4 border-slate-600 flex items-center justify-center transition-all hover:bg-slate-600 hover:scale-105 active:scale-95 shadow-xl">
                            <svg id="mic-icon" class="w-8 h-8 md:w-10 md:h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                        </button>
                        <div class="flex gap-2 w-full justify-center">
                            <button id="play-recording-btn" disabled class="btn-modern px-4 py-2 bg-green-600/80 hover:bg-green-500 text-white text-xs md:text-sm shadow-lg disabled:opacity-50 disabled:cursor-not-allowed w-full">‚ñ∂ Play</button>
                            <button id="loop-btn" disabled class="btn-modern px-4 py-2 bg-indigo-600/80 hover:bg-indigo-500 text-white text-xs md:text-sm shadow-lg disabled:opacity-50 disabled:cursor-not-allowed w-full transition-colors">üîÅ Loop</button>
                        </div>
                         <button id="save-track-btn" class="btn-modern w-full py-2 bg-blue-600/80 hover:bg-blue-500 text-white text-xs md:text-sm shadow-lg">üíæ Save Track</button>
                    </div>

                    <div class="flex-1 bg-slate-800/30 rounded-2xl p-4 flex flex-col gap-3 border border-white/5">
                        <div class="grid grid-cols-2 gap-2 h-full">
                            <button class="btn-modern effect-btn selected text-xs p-2" data-effect="normal">Normal</button>
                            <button class="btn-modern effect-btn text-xs p-2" data-effect="chipmunk">üêøÔ∏è Chipmunk</button>
                            <button class="btn-modern effect-btn text-xs p-2" data-effect="monster">üëπ Monster</button>
                            <button class="btn-modern effect-btn text-xs p-2" data-effect="robot">ü§ñ Robot</button>
                        </div>
                        <button id="pro-tuner-toggle" class="pro-tuner-btn w-full py-3 rounded-xl bg-slate-700/50 hover:bg-slate-700 font-bold text-sm flex items-center justify-center gap-2 border border-white/10 transition-all">
                            ‚≠ê Pro-Tuner Studio
                        </button>
                    </div>
                </div>

                <div id="tuner-console" class="hidden mt-4 tuner-panel p-5 rounded-2xl animate-fadeIn">
                    <h3 class="text-sm font-bold text-white mb-3 flex items-center gap-2">üéõÔ∏è Auto-Tune Settings</h3>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="bg-black/20 p-3 rounded-xl border border-white/5"><label class="block text-[10px] font-bold text-pink-200 mb-2">PITCH</label><input type="range" id="tune-pitch" min="0.5" max="2.0" step="0.1" value="1.0" class="w-full"></div>
                        <div class="bg-black/20 p-3 rounded-xl border border-white/5"><label class="block text-[10px] font-bold text-blue-200 mb-2">WOBBLE</label><input type="range" id="tune-robot" min="0" max="100" value="0" class="w-full"></div>
                        <div class="bg-black/20 p-3 rounded-xl border border-white/5"><label class="block text-[10px] font-bold text-purple-200 mb-2">REVERB</label><input type="range" id="tune-reverb" min="0" max="100" value="20" class="w-full"></div>
                    </div>
                </div>
            </div>

            <div class="glass-panel mixer-panel p-4 flex gap-4 items-center sticky bottom-24 md:static z-30 shadow-2xl">
                <span class="text-2xl filter drop-shadow-md">üéöÔ∏è</span>
                <div class="flex-1">
                    <label class="text-[10px] font-bold text-slate-300 uppercase tracking-wider mb-1 block">Voice Volume</label>
                    <input type="range" id="voice-vol" min="0" max="1.5" step="0.05" value="1" class="w-full h-2 bg-slate-700 rounded-lg accent-yellow-400">
                </div>
                 <button id="stop-all-btn" class="btn-modern bg-red-600 hover:bg-red-500 py-3 px-4 text-white font-bold text-xs shadow-lg border-red-400/30 whitespace-nowrap">üõë STOP ALL</button>
            </div>
        </div>

        <!-- VIEW: STORY MAGIC -->
        <div id="view-story" class="view-section">
            <div class="glass-panel p-6 bg-gradient-to-br from-indigo-900/80 to-slate-900/80 border border-indigo-500/30">
                <h2 class="text-2xl md:text-3xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-purple-400">‚ú® AI Story-to-Song</h2>
                <p class="text-slate-300 mb-5 text-sm md:text-base">Write a story, choose a voice, and I'll sing it smartly!</p>
                
                <textarea id="story-input" class="w-full h-32 bg-slate-800/50 border border-slate-600/50 rounded-xl p-4 text-white placeholder-slate-500 focus:outline-none focus:border-purple-500 focus:bg-slate-800 transition-all text-base leading-relaxed resize-none" placeholder="Once there was a little robot who loved to dance in the rain..."></textarea>
                
                <div class="mt-4 flex flex-col md:flex-row gap-3">
                    <label class="text-sm font-bold text-slate-400 uppercase tracking-wider flex items-center">üéôÔ∏è Select AI Singer:</label>
                    <div class="flex gap-2 flex-grow">
                        <button class="voice-btn btn-modern flex-1 py-2 text-xs selected" data-voice="star">‚≠ê Star (Energy)</button>
                        <button class="voice-btn btn-modern flex-1 py-2 text-xs" data-voice="buddy">üêª Buddy (Friendly)</button>
                        <button class="voice-btn btn-modern flex-1 py-2 text-xs" data-voice="sage">ü¶â Sage (Calm)</button>
                    </div>
                </div>

                <div class="flex gap-2 mt-5">
                     <button id="magic-btn" class="btn-modern flex-1 py-4 bg-gradient-to-r from-fuchsia-600 to-purple-600 rounded-xl text-lg font-bold shadow-lg hover:scale-[1.02] active:scale-95 border-0">
                        ü™Ñ Compose Song
                    </button>
                </div>
            </div>

            <!-- Immersive Story Player -->
            <div id="story-player" class="glass-panel p-0 hidden animate-fadeIn relative overflow-hidden min-h-[400px] flex flex-col">
                <div class="absolute inset-0 bg-gradient-to-t from-purple-900/80 via-slate-900/50 to-transparent pointer-events-none"></div>

                <div class="relative z-10 flex flex-col h-full p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg md:text-xl font-bold text-yellow-300 flex items-center gap-2">üé∂ Now Performing</h3>
                        <div class="flex gap-2">
                            <button id="export-studio-btn" class="btn-modern bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 text-xs font-bold shadow-lg gap-1 border-0">
                                üéõÔ∏è Remix
                            </button>
                             <button id="stop-story-btn" class="btn-modern bg-slate-700/80 hover:bg-slate-600 text-white px-3 py-1.5 text-xs border-0">Close</button>
                        </div>
                    </div>
                    
                    <div id="karaoke-display" class="flex-grow text-xl md:text-3xl font-bold text-center leading-relaxed flex flex-wrap justify-center items-center gap-x-2 gap-y-1 mb-8 p-6 bg-black/20 rounded-2xl border border-white/5 backdrop-blur-sm">
                        <!-- Lyrics go here -->
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-auto">
                         <button id="remix-beat-btn" class="btn-modern p-4 bg-cyan-900/40 hover:bg-cyan-800/60 rounded-xl border-cyan-500/30 text-cyan-200 text-sm font-bold border">
                            üé≤ Remix Beat
                        </button>
                        <button id="ai-sing-btn" class="btn-modern p-4 bg-pink-900/40 hover:bg-pink-800/60 rounded-xl border-pink-500/30 text-pink-200 text-sm font-bold border relative overflow-hidden">
                            <span class="relative z-10">ü§ñ Smart Sing It!</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: GAMES -->
        <div id="view-games" class="view-section">
            <h2 class="text-2xl md:text-3xl font-bold text-center text-green-400 mb-4">üéÆ Music Games</h2>
            <div class="glass-panel p-6 text-center max-w-md mx-auto">
                <h3 class="text-xl font-bold text-white mb-2">ü•Å Rhythm Mimic</h3>
                <p class="text-slate-400 mb-6 text-sm">Watch the pads light up, then repeat the pattern!</p>
                <div id="game-status" class="text-2xl font-black text-yellow-400 mb-6 h-10 flex items-center justify-center">Press Start!</div>
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <button id="game-pad-0" class="aspect-square bg-red-500 rounded-2xl shadow-lg opacity-80 border-4 border-transparent transition-all active:scale-95"></button>
                    <button id="game-pad-1" class="aspect-square bg-blue-500 rounded-2xl shadow-lg opacity-80 border-4 border-transparent transition-all active:scale-95"></button>
                    <button id="game-pad-2" class="aspect-square bg-green-500 rounded-2xl shadow-lg opacity-80 border-4 border-transparent transition-all active:scale-95"></button>
                    <button id="game-pad-3" class="aspect-square bg-yellow-500 rounded-2xl shadow-lg opacity-80 border-4 border-transparent transition-all active:scale-95"></button>
                </div>
                <button id="start-game-btn" class="btn-modern px-10 py-4 bg-green-600 rounded-full font-bold text-lg hover:bg-green-500 shadow-xl hover:scale-105 border-0 w-full">Start Level 1</button>
            </div>
        </div>

        <!-- VIEW: CONCERT STAGE -->
        <div id="view-concert" class="view-section">
            <h2 class="text-2xl md:text-3xl font-bold text-center text-purple-400 mb-4">üéÜ Magic Concert Stage</h2>
            
            <div class="relative w-full aspect-video glass-panel overflow-hidden bg-black flex items-center justify-center border-2 border-slate-700 rounded-2xl shadow-2xl">
                <!-- Stage Canvas -->
                <canvas id="stage-canvas" class="absolute inset-0 w-full h-full"></canvas>
                
                <div class="absolute top-4 right-4 flex gap-2">
                    <button class="world-btn btn-modern bg-black/40 hover:bg-black/60 text-white p-2 rounded-lg backdrop-blur-md text-xs border-white/20" data-world="space">üöÄ</button>
                    <button class="world-btn btn-modern bg-black/40 hover:bg-black/60 text-white p-2 rounded-lg backdrop-blur-md text-xs border-white/20" data-world="disco">üíÉ</button>
                    <button class="world-btn btn-modern bg-black/40 hover:bg-black/60 text-white p-2 rounded-lg backdrop-blur-md text-xs border-white/20" data-world="sea">üê†</button>
                </div>

                <div class="absolute bottom-4 left-4 right-4 flex justify-center flex-wrap gap-3 bg-black/60 p-3 rounded-2xl backdrop-blur-md border border-white/10">
                    <button class="stage-ctrl text-2xl hover:scale-125 transition active:scale-90" data-action="confetti">üéâ</button>
                    <button class="stage-ctrl text-2xl hover:scale-125 transition active:scale-90" data-action="fireworks">üéÜ</button>
                    <button class="stage-ctrl text-2xl hover:scale-125 transition active:scale-90" data-action="lasers">‚ö°</button>
                    <button class="stage-ctrl text-2xl hover:scale-125 transition active:scale-90" data-action="bubbles">ü´ß</button>
                    <div class="w-px bg-white/20 mx-1 hidden md:block"></div>
                    <button class="stage-ctrl text-2xl hover:scale-125 transition active:scale-90" data-char="cat">üê±</button>
                    <button class="stage-ctrl text-2xl hover:scale-125 transition active:scale-90" data-char="robot">ü§ñ</button>
                    <button class="stage-ctrl text-2xl hover:scale-125 transition active:scale-90" data-char="alien">üëΩ</button>
                </div>
            </div>
            <div class="glass-panel p-3 text-center mt-2 bg-indigo-900/30 border-0">
                <p class="text-xs md:text-sm text-slate-300">Play music in the <b>Studio</b> to see the characters dance!</p>
            </div>
        </div>

        <!-- VIEW: GALLERY -->
        <div id="view-gallery" class="view-section">
            <h2 class="text-2xl md:text-3xl font-bold text-center text-blue-400 mb-4">üíæ Family Gallery</h2>
            <div class="glass-panel p-6 min-h-[50vh] flex flex-col">
                <div id="gallery-list" class="flex flex-col gap-3 max-h-[50vh] overflow-y-auto pr-2 flex-grow">
                    <div class="flex flex-col items-center justify-center h-40 text-slate-500 animate-pulse">
                        <span class="text-4xl mb-2">‚òÅÔ∏è</span>
                        <p>Connecting to Tiwaton Cloud...</p>
                    </div>
                </div>
                <button id="clear-gallery" class="mt-6 btn-modern text-xs bg-red-900/20 text-red-300 border-red-800/30 w-full py-3 hover:bg-red-900/40">Clear All Data</button>
            </div>
        </div>

    </div>

    <!-- NAV DOCK -->
    <nav id="nav-dock" class="nav-dock hidden">
        <button class="nav-btn active" data-target="view-studio">üéπ Studio</button>
        <button class="nav-btn" data-target="view-story">‚ú® Story</button>
        <button class="nav-btn" data-target="view-games">üéÆ Games</button>
        <button class="nav-btn" data-target="view-concert">üéÜ Stage</button>
        <button class="nav-btn" data-target="view-gallery">üíæ Gallery</button>
    </nav>

    <script>
        // --- FIREBASE INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyAuc_qVtzxpk1EeahGt-_KoBEMxOTdBm5U",
            authDomain: "tiwaton-family-adventure.firebaseapp.com",
            projectId: "tiwaton-family-adventure",
            storageBucket: "tiwaton-family-adventure.firebasestorage.app",
            messagingSenderId: "53083980470",
            appId: "1:53083980470:web:dc41aa974cda42eaf61c17"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // Anonymous Auth
        firebase.auth().signInAnonymously().catch(err => console.log("Auth Error (Check Rules):", err));

        // --- MOTHER APP INTEGRATION BRIDGE ---
        const urlParams = new URLSearchParams(window.location.search);
        const embeddedChildName = urlParams.get('childName');
        const isEmbedded = window.self !== window.top;

        if (embeddedChildName) {
            document.querySelector('#user-profile span:first-child').innerText = 'üë§ ' + embeddedChildName;
        }

        window.addEventListener('message', (event) => {
            if (event.data?.type === 'SET_USER') {
                 document.querySelector('#user-profile span:first-child').innerText = 'üë§ ' + event.data.name;
            }
        });

        function notifyHost(type, data) {
            if(isEmbedded) {
                window.parent.postMessage({ source: 'sonic-magic', type, data }, '*');
            }
        }

        // --- Shared Audio Engine ---
        let audioCtx, analyser, dataArray;
        let compressorNode, voiceGainNode;
        let impulseBuffer;
        let activeSourceNode = null;
        let isRecording = false, mediaRecorder, chunks = [], recordedAudioBuffer = null;
        let recordedBlob = null;
        let animationFrameIds = {}; 
        let isLooping = false;
        
        // --- UI State ---
        let currentEffect = 'normal';
        let isMuted = false;
        let activeStoryBeat = null;
        let isStoryModeAIActive = false;
        let appActive = false;
        let selectedVoice = 'star'; 
        let storyInterval = null; // Defined here to be global
        let storyTempo = 500;
        
        // --- Particle System ---
        function createParticles() {
            const container = document.getElementById('particles-container');
            container.innerHTML = ''; 
            const notes = ['‚ô™', '‚ô´', '‚ô¨', '‚ô©'];
            for(let i=0; i<15; i++) {
                const el = document.createElement('div');
                el.className = 'note-particle';
                el.innerText = notes[Math.floor(Math.random() * notes.length)];
                el.style.left = Math.random() * 100 + 'vw';
                el.style.animationDuration = (Math.random() * 3 + 5) + 's';
                el.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(el);
            }
        }
        createParticles();

        // --- Init Audio ---
        async function initAudio() {
            if(audioCtx) {
                if(audioCtx.state === 'suspended') await audioCtx.resume();
            } else {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                
                const length = audioCtx.sampleRate * 2.0;
                impulseBuffer = audioCtx.createBuffer(2, length, audioCtx.sampleRate);
                for (let i=0; i<length; i++) {
                    const n = i/length;
                    const noise = (Math.random()*2-1)*Math.pow(1-n, 3);
                    impulseBuffer.getChannelData(0)[i] = noise;
                    impulseBuffer.getChannelData(1)[i] = noise;
                }

                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                analyser.connect(audioCtx.destination); 

                compressorNode = audioCtx.createDynamicsCompressor();
                voiceGainNode = audioCtx.createGain();
                compressorNode.connect(voiceGainNode);
                voiceGainNode.connect(analyser);
            }

            if (!mediaRecorder) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = e => chunks.push(e.data);
                    mediaRecorder.onstop = async () => {
                        recordedBlob = new Blob(chunks, { 'type' : 'audio/ogg; codecs=opus' });
                        chunks = [];
                        const ab = await recordedBlob.arrayBuffer();
                        recordedAudioBuffer = await audioCtx.decodeAudioData(ab);
                        document.getElementById('play-recording-btn').disabled = false;
                        document.getElementById('play-recording-btn').classList.remove('opacity-50');
                        document.getElementById('loop-btn').disabled = false;
                        document.getElementById('loop-btn').classList.remove('opacity-50');
                    };
                } catch(e) { console.log("Mic access denied or error", e); }
            }
        }

        // --- View Transitions ---
        function enterStudio() {
            appActive = true;
            initAudio();
            document.getElementById('landing-page').classList.add('hidden-visually');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('nav-dock').classList.remove('hidden');
            document.getElementById('nav-dock').style.display = 'flex';
            
            // Resume/Start Loops
            drawVisualizer();
            drawStage();
            initGalleryListener();
            notifyHost('OPENED', {});
        }

        function exitStudio() {
            appActive = false;
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('nav-dock').classList.add('hidden');
            document.getElementById('landing-page').classList.remove('hidden-visually');
            if(activeSourceNode) activeSourceNode.stop();
            if(storyInterval) clearInterval(storyInterval);
            if(window.studioLoop) clearInterval(window.studioLoop);
            if(audioCtx) audioCtx.suspend();
            window.speechSynthesis.cancel();
            createParticles();
            notifyHost('CLOSED', {});
        }

        document.getElementById('enter-btn').addEventListener('click', enterStudio);
        document.getElementById('exit-btn').addEventListener('click', exitStudio);

        // --- Navigation ---
        const navButtons = document.querySelectorAll('.nav-btn');
        const views = document.querySelectorAll('.view-section');
        navButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                navButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                views.forEach(v => v.classList.remove('active'));
                document.getElementById(btn.dataset.target).classList.add('active');
            });
        });

        // --- STUDIO LOGIC ---
        const pads = [
            { id: 0, name: 'Kick', icon: 'ü•Å', color: 'bg-red-600', type: 'drum', freq: 150 },
            { id: 16, name: 'Deep Kick', icon: 'üí£', color: 'bg-red-800', type: 'deepkick' },
            { id: 12, name: 'Tom', icon: 'ü™ò', color: 'bg-red-500', type: 'tom' },
            { id: 17, name: 'Floor Tom', icon: 'üìâ', color: 'bg-red-700', type: 'floortom' },
            { id: 18, name: 'Elec Tom', icon: 'üëæ', color: 'bg-pink-600', type: 'electom' },
            { id: 1, name: 'Snare', icon: 'ü•¢', color: 'bg-orange-500', type: 'snare' },
            { id: 19, name: 'Rimshot', icon: 'üìç', color: 'bg-orange-400', type: 'rimshot' },
            { id: 3, name: 'Clap', icon: 'üëè', color: 'bg-amber-500', type: 'clap' },
            { id: 2, name: 'Hi-Hat', icon: 'üìÄ', color: 'bg-yellow-500', type: 'hat' },
            { id: 14, name: 'Open Hat', icon: 'üíø', color: 'bg-yellow-400', type: 'openhat' },
            { id: 13, name: 'Shaker', icon: 'üßÇ', color: 'bg-orange-300', type: 'shaker' },
            { id: 15, name: 'Cowbell', icon: 'üîî', color: 'bg-amber-400', type: 'cowbell' },
            { id: 4, name: 'Laser', icon: 'üî´', color: 'bg-green-600', type: 'synth', freq: 800, slide: true },
            { id: 7, name: 'Zap', icon: '‚ö°', color: 'bg-cyan-600', type: 'synth', freq: 1200, slide: true },
            { id: 6, name: 'Magic', icon: '‚ú®', color: 'bg-teal-500', type: 'synth', freq: 600, magic: true },
            { id: 5, name: 'Bass', icon: 'üé∏', color: 'bg-emerald-600', type: 'synth', freq: 65, typeW: 'square' },
            { id: 8, name: 'C Maj', icon: 'üéπ', color: 'bg-blue-600', type: 'chord', notes: [261, 329, 392] },
            { id: 9, name: 'F Maj', icon: 'üéπ', color: 'bg-indigo-600', type: 'chord', notes: [349, 440, 523] },
            { id: 10, name: 'G Maj', icon: 'üéπ', color: 'bg-violet-600', type: 'chord', notes: [392, 493, 587] },
            { id: 11, name: 'A Min', icon: 'üéπ', color: 'bg-purple-600', type: 'chord', notes: [440, 523, 659] },
        ];
        
        function generatePads() {
            const container = document.getElementById('pad-container');
            container.innerHTML = '';
            pads.forEach(pad => {
                const btn = document.createElement('button');
                btn.id = `pad-${pad.id}`;
                btn.className = `pad-btn w-full aspect-square rounded-xl ${pad.color} text-white font-bold text-[10px] md:text-sm shadow-lg border border-white/10`;
                btn.innerHTML = `<span class="text-lg md:text-2xl filter drop-shadow-md">${pad.icon}</span><span class="text-[8px] md:text-[10px] uppercase tracking-wide opacity-90 leading-none">${pad.name}</span>`;
                const trigger = (e) => {
                    // Prevent both mousedown and touchstart from firing
                    if (e.type === 'touchstart') {
                        e.preventDefault();
                    }
                    playPad(pad);
                    btn.classList.add('active');
                    setTimeout(() => btn.classList.remove('active'), 150);
                };
                
                // Use pointerdown for a unified event, but if not available, careful fallback
                if (window.PointerEvent) {
                    btn.onpointerdown = (e) => {
                        e.preventDefault();
                        btn.setPointerCapture(e.pointerId);
                        playPad(pad);
                        btn.classList.add('active');
                        setTimeout(() => btn.classList.remove('active'), 150);
                    };
                } else {
                    btn.addEventListener('mousedown', trigger);
                    btn.addEventListener('touchstart', trigger);
                }
                container.appendChild(btn);
            });
        }
        generatePads();

        function playPad(pad) {
            if (!audioCtx || audioCtx.state === 'suspended') return;
            const now = audioCtx.currentTime;
            const gain = audioCtx.createGain();
            gain.connect(analyser);

            if (pad.type === 'drum') {
                const osc = audioCtx.createOscillator();
                osc.frequency.setValueAtTime(pad.freq, now);
                osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.5);
                gain.gain.setValueAtTime(1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.connect(gain); osc.start(now); osc.stop(now + 0.5);
            }
            else if (pad.type === 'deepkick') {
                const osc = audioCtx.createOscillator();
                osc.frequency.setValueAtTime(60, now);
                osc.frequency.exponentialRampToValueAtTime(30, now + 0.8);
                gain.gain.setValueAtTime(1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.8);
                osc.connect(gain); osc.start(now); osc.stop(now + 0.8);
            }
            else if (pad.type === 'tom' || pad.type === 'floortom' || pad.type === 'electom') {
                const osc = audioCtx.createOscillator();
                osc.type = pad.type === 'electom' ? 'square' : (pad.type === 'floortom' ? 'triangle' : 'sine');
                const startFreq = pad.type === 'floortom' ? 120 : (pad.type === 'electom' ? 300 : 200);
                const endFreq = pad.type === 'electom' ? 50 : (pad.type === 'floortom' ? 40 : 80);
                osc.frequency.setValueAtTime(startFreq, now);
                osc.frequency.exponentialRampToValueAtTime(endFreq, now + 0.3);
                gain.gain.setValueAtTime(0.8, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                
                if(pad.type === 'electom') {
                    const filt = audioCtx.createBiquadFilter();
                    filt.type = 'lowpass'; filt.frequency.value = 600;
                    osc.connect(filt).connect(gain);
                } else {
                    osc.connect(gain);
                }
                osc.start(now); osc.stop(now + 0.3);
            }
            else if (pad.type === 'snare') {
                const osc = audioCtx.createOscillator();
                osc.type = 'triangle'; osc.frequency.setValueAtTime(180, now);
                const oscGain = audioCtx.createGain();
                oscGain.gain.setValueAtTime(0.5, now); oscGain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.connect(oscGain); oscGain.connect(gain); osc.start(now); osc.stop(now+0.2);
                const buf = audioCtx.createBuffer(1, audioCtx.sampleRate*0.4, audioCtx.sampleRate);
                const d = buf.getChannelData(0); for(let i=0; i<d.length; i++) d[i] = Math.random()*2-1;
                const src = audioCtx.createBufferSource(); src.buffer = buf;
                const filt = audioCtx.createBiquadFilter(); filt.type = 'highpass'; filt.frequency.value = 800;
                gain.gain.setValueAtTime(0.8, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.3);
                src.connect(filt).connect(gain); src.start(now);
            }
            else if (pad.type === 'rimshot') {
                const osc = audioCtx.createOscillator();
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.05);
                gain.gain.setValueAtTime(0.6, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                osc.connect(gain); osc.start(now); osc.stop(now + 0.05);
            }
            else if (pad.type === 'hat' || pad.type === 'openhat' || pad.type === 'shaker') {
                const len = pad.type === 'openhat' ? 0.5 : 0.1;
                const freq = pad.type === 'shaker' ? 3000 : (pad.type === 'openhat' ? 4000 : 6000);
                const buf = audioCtx.createBuffer(1, audioCtx.sampleRate*len, audioCtx.sampleRate);
                const d = buf.getChannelData(0); for(let i=0; i<d.length; i++) d[i] = Math.random()*2-1;
                const src = audioCtx.createBufferSource(); src.buffer = buf;
                const filt = audioCtx.createBiquadFilter(); filt.type = 'highpass'; filt.frequency.value = freq;
                gain.gain.setValueAtTime(0.4, now); gain.gain.exponentialRampToValueAtTime(0.01, now+len);
                src.connect(filt).connect(gain); src.start(now);
            }
            else if (pad.type === 'clap') {
                const buf = audioCtx.createBuffer(1, audioCtx.sampleRate*0.4, audioCtx.sampleRate);
                const d = buf.getChannelData(0); for(let i=0; i<d.length; i++) d[i] = Math.random()*2-1;
                const src = audioCtx.createBufferSource(); src.buffer = buf;
                const filt = audioCtx.createBiquadFilter(); filt.type = 'bandpass'; filt.frequency.value = 1500;
                gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.8, now + 0.01); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                src.connect(filt).connect(gain); src.start(now);
            }
            else if (pad.type === 'cowbell') {
                const osc1 = audioCtx.createOscillator(); osc1.type = 'square'; osc1.frequency.value = 580;
                const osc2 = audioCtx.createOscillator(); osc2.type = 'square'; osc2.frequency.value = 840;
                const mixGain = audioCtx.createGain(); mixGain.gain.value = 0.3;
                osc1.connect(mixGain); osc2.connect(mixGain);
                const filt = audioCtx.createBiquadFilter(); filt.type = 'bandpass'; filt.frequency.value = 1000;
                mixGain.connect(filt).connect(gain);
                gain.gain.setValueAtTime(0.6, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.2);
                osc1.start(now); osc2.start(now); osc1.stop(now+0.2); osc2.stop(now+0.2);
            }
            else if (pad.type === 'synth' || pad.type === 'chord') {
                const oscs = pad.notes || [pad.freq];
                oscs.forEach(f => {
                    const osc = audioCtx.createOscillator();
                    osc.type = pad.typeW || (pad.type === 'drum' ? 'sine' : 'triangle');
                    osc.frequency.setValueAtTime(f, now);
                    if (pad.slide) osc.frequency.exponentialRampToValueAtTime(f/2, now+0.3);
                    if (pad.magic) {
                        const lfo = audioCtx.createOscillator();
                        lfo.frequency.value = 20;
                        const lfoG = audioCtx.createGain();
                        lfoG.gain.value = 500;
                        lfo.connect(lfoG).connect(osc.frequency);
                        lfo.start(now);
                    }
                    gain.gain.setValueAtTime(0.3, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                    osc.connect(gain);
                    osc.start(now); osc.stop(now+0.5);
                });
            }
            triggerStageEffect('beat');
        }

        // --- GAMES LOGIC (Rhythm Mimic) ---
        let gameLevel = 1;
        let gameSequence = [];
        let playerSequence = [];
        let isGameActive = false;
        
        document.getElementById('start-game-btn').onclick = startGame;
        
        for(let i=0; i<4; i++) {
            const btn = document.getElementById(`game-pad-${i}`);
            btn.onclick = () => handleGameInput(i);
        }

        function startGame() {
            if (!audioCtx) initAudio();
            gameLevel = 1;
            gameSequence = [];
            playerSequence = [];
            isGameActive = false;
            document.getElementById('start-game-btn').classList.add('hidden');
            nextLevel();
        }

        function nextLevel() {
            playerSequence = [];
            isGameActive = false;
            document.getElementById('game-status').innerText = `Level ${gameLevel}: Watch!`;
            document.getElementById('game-status').className = "text-2xl font-black text-blue-400 mb-6 h-10 flex items-center justify-center animate-pulse";
            gameSequence.push(Math.floor(Math.random() * 4));
            let i = 0;
            const interval = setInterval(() => {
                if (i >= gameSequence.length) {
                    clearInterval(interval);
                    isGameActive = true; 
                    document.getElementById('game-status').innerText = "Your Turn!";
                    document.getElementById('game-status').className = "text-2xl font-black text-yellow-400 mb-6 h-10 flex items-center justify-center";
                    return;
                }
                flashGamePad(gameSequence[i]);
                i++;
            }, 800);
        }

        function flashGamePad(padId) {
            const btn = document.getElementById(`game-pad-${padId}`);
            if(btn) {
                btn.classList.add('game-flash');
                setTimeout(() => btn.classList.remove('game-flash'), 400);
                playPad(pads[padId]); 
            }
        }

        function handleGameInput(padId) {
            if (!isGameActive) return;
            flashGamePad(padId);
            playerSequence.push(padId);
            const currentIdx = playerSequence.length - 1;
            if (playerSequence[currentIdx] !== gameSequence[currentIdx]) {
                gameOver();
            } else {
                if (playerSequence.length === gameSequence.length) {
                    levelComplete();
                }
            }
        }

        function levelComplete() {
            isGameActive = false;
            document.getElementById('game-status').innerText = "‚úÖ Great Job!";
            document.getElementById('game-status').className = "text-2xl font-black text-green-400 mb-6 h-10 flex items-center justify-center";
            gameLevel++;
            setTimeout(nextLevel, 1500);
        }

        function gameOver() {
            isGameActive = false;
            document.getElementById('game-status').innerText = "‚ùå Oops! Try Again.";
            document.getElementById('game-status').className = "text-2xl font-black text-red-400 mb-6 h-10 flex items-center justify-center";
            const startBtn = document.getElementById('start-game-btn');
            startBtn.innerText = "Restart Game";
            startBtn.classList.remove('hidden');
        }

        document.getElementById('record-btn').onclick = function() {
            if (!mediaRecorder) {
                alert("Microphone not ready or permission denied.");
                return;
            }
            
            if(!isRecording) {
                if (mediaRecorder.state === 'inactive') {
                    try {
                        mediaRecorder.start();
                        isRecording = true;
                        this.classList.add('recording-pulse', 'bg-red-600');
                    } catch (e) {
                        console.error("Error starting recorder:", e);
                        alert("Could not start recording. Please check microphone permissions.");
                    }
                }
            } else {
                if (mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    isRecording = false;
                    this.classList.remove('recording-pulse', 'bg-red-600');
                }
            }
        };

        // --- FIXED BUTTON LOGIC ---
        
        // 1. Effects Selection - RESTART PLAYBACK ON CHANGE
        const effectBtns = document.querySelectorAll('.effect-btn');
        effectBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                effectBtns.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                currentEffect = btn.dataset.effect;
                
                // Smart Restart: If currently playing/looping, restart immediately to apply effect
                if (activeSourceNode) {
                    startPlayback(true);
                }
            });
        });

        // 2. Pro-Tuner Toggle
        const proTunerBtn = document.getElementById('pro-tuner-toggle');
        const tunerConsole = document.getElementById('tuner-console');
        proTunerBtn.addEventListener('click', () => {
            tunerConsole.classList.toggle('hidden');
            proTunerBtn.classList.toggle('selected');
        });
        
        // Real-time tuner updates
        ['tune-pitch', 'tune-robot', 'tune-reverb'].forEach(id => {
            document.getElementById(id).addEventListener('input', () => {
                if(activeSourceNode) {
                    // For simple pitch, we can update live without full restart if in simple mode
                    // But for complex chain (Robot LFO), restart is safer or we need active node refs
                    // Given the request for "smart/intelligent", let's update live if possible, else restart
                    startPlayback(true); // Restart is the cleanest way to guarantee new chain structure
                }
            });
        });

        // 3. Loop Toggle
        const loopBtn = document.getElementById('loop-btn');
        loopBtn.addEventListener('click', () => {
            isLooping = !isLooping;
            if(isLooping) {
                loopBtn.classList.add('loop-active');
            } else {
                loopBtn.classList.remove('loop-active');
            }
            if(activeSourceNode) activeSourceNode.loop = isLooping;
        });

        // 4. Volume Control
        const volSlider = document.getElementById('voice-vol');
        volSlider.addEventListener('input', (e) => {
            if(voiceGainNode) voiceGainNode.gain.value = e.target.value;
        });

        // 5. Updated Playback Logic - Extracted to function
        function startPlayback(isRestart = false) {
             if(!recordedAudioBuffer) return;
             
             // If this is a restart (e.g. effect change), stop current sound
             if(activeSourceNode) {
                 try { activeSourceNode.stop(); } catch(e){}
             }

             const source = audioCtx.createBufferSource();
             source.buffer = recordedAudioBuffer;
             source.loop = isLooping;
             
             let lastNode = source;

             // --- EFFECT PROCESSING ---
             // We construct the graph fresh every time based on current settings
             
             let pitch = 1.0;
             let wobble = 0;
             let reverbAmt = 0;

             // Standard Presets
             if (currentEffect === 'chipmunk') {
                 pitch = 1.5;
             } else if (currentEffect === 'monster') {
                 pitch = 0.7;
             } else if (currentEffect === 'robot') {
                 wobble = 50; // Strong wobble
             }

             // Pro-Tuner Overrides (if visible)
             if (!tunerConsole.classList.contains('hidden')) {
                 pitch = parseFloat(document.getElementById('tune-pitch').value);
                 const tunerWobble = parseFloat(document.getElementById('tune-robot').value);
                 reverbAmt = parseFloat(document.getElementById('tune-reverb').value);
                 if(tunerWobble > 0) wobble = tunerWobble;
             }

             source.playbackRate.value = pitch;

             if (wobble > 0) {
                 const lfo = audioCtx.createOscillator();
                 lfo.frequency.value = wobble / 2; // LFO speed
                 const lfoGain = audioCtx.createGain();
                 lfoGain.gain.value = 500; // Depth
                 // For true ring mod robot, we modulate gain, but here we mod pitch for "wobble"
                 // Or simple ring mod:
                 if(currentEffect === 'robot' || wobble > 30) {
                     // Ring Mod style
                     lfo.connect(lfoGain);
                     // Create a gain node for the source to be modulated
                     const modGain = audioCtx.createGain();
                     modGain.gain.value = 1.0;
                     lfoGain.connect(modGain.gain);
                     lastNode.connect(modGain);
                     lastNode = modGain;
                 } else {
                     // Vibrato style
                     lfoGain.gain.value = 0.1;
                     lfo.connect(lfoGain).connect(source.playbackRate);
                 }
                 lfo.start();
             }
             
             if (reverbAmt > 0 && impulseBuffer) {
                 const conv = audioCtx.createConvolver();
                 conv.buffer = impulseBuffer;
                 const wet = audioCtx.createGain();
                 wet.gain.value = reverbAmt / 100;
                 const dry = audioCtx.createGain();
                 dry.gain.value = 1 - (reverbAmt/200); 
                 
                 // Split path
                 lastNode.connect(conv);
                 conv.connect(wet);
                 wet.connect(voiceGainNode);
                 
                 lastNode.connect(dry);
                 lastNode = dry; 
             }

             lastNode.connect(voiceGainNode);
             source.start();
             activeSourceNode = source;
        }

        document.getElementById('play-recording-btn').onclick = () => startPlayback(false);

        document.getElementById('stop-all-btn').onclick = () => {
            if(activeSourceNode) activeSourceNode.stop();
            if(storyInterval) clearInterval(storyInterval);
            if(window.studioLoop) clearInterval(window.studioLoop);
            window.speechSynthesis.cancel();
        };

        // --- STORY MAGIC ---
        
        document.querySelectorAll('.voice-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.voice-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedVoice = btn.dataset.voice;
            });
        });

        document.getElementById('magic-btn').onclick = () => {
            const text = document.getElementById('story-input').value;
            if(!text.trim()) return alert("Write a story first!");
            
            document.getElementById('view-story').querySelector('.glass-panel').classList.add('hidden');
            document.getElementById('story-player').classList.remove('hidden');
            
            const display = document.getElementById('karaoke-display');
            display.innerHTML = text.split(' ').map(w => `<span class="karaoke-word">${w}</span>`).join(' ');
            
            createProceduralBeat(text);
            startStoryLoop();
            startKaraoke(text);
        };

        function createProceduralBeat(text) {
            const isHappy = text.includes('happy') || text.includes('fun') || text.includes('sun');
            const isFast = text.includes('run') || text.includes('fast') || text.includes('race');
            
            storyTempo = isFast ? 300 : (isHappy ? 400 : 600);
            
            activeStoryBeat = [
                [0, 2],         // Beat 1
                [],             // Beat 2
                [1, 2],         // Beat 3
                [5]             // Beat 4
            ];
            
            if(isHappy) activeStoryBeat[1].push(8); 
            else activeStoryBeat[1].push(11); 
        }

        document.getElementById('remix-beat-btn').onclick = () => {
            activeStoryBeat = [
                Math.random() > 0.5 ? [0] : [0, 2],
                Math.random() > 0.5 ? [2] : [8],
                Math.random() > 0.5 ? [1] : [1, 2],
                Math.random() > 0.5 ? [5] : [4]
            ];
        };

        function startStoryLoop() {
            if(storyInterval) clearInterval(storyInterval);
            let beatIndex = 0;
            storyInterval = setInterval(() => {
                if(appActive) {
                    const currentStep = activeStoryBeat[beatIndex % 4];
                    currentStep.forEach(padId => playPad(pads[padId]));
                    beatIndex++;
                }
            }, storyTempo);
        }

        function startKaraoke(text) {
            const words = document.querySelectorAll('.karaoke-word');
            let i = 0;
            const interval = setInterval(() => {
                if(!storyInterval || i >= words.length) {
                    clearInterval(interval);
                    return;
                }
                words.forEach(w => w.classList.remove('karaoke-active'));
                words[i].classList.add('karaoke-active');
                i++;
            }, storyTempo); 
        }

        document.getElementById('ai-sing-btn').onclick = () => {
            const text = document.getElementById('story-input').value;
            if ('speechSynthesis' in window) {
                const synth = window.speechSynthesis;
                synth.cancel();

                const voices = synth.getVoices();
                let targetVoice = null;
                const enVoices = voices.filter(v => v.lang.startsWith('en'));
                
                if (selectedVoice === 'star') {
                    targetVoice = enVoices.find(v => v.name.includes('Google US English')) || enVoices.find(v => v.name.includes('Samantha')) || enVoices[0];
                } else if (selectedVoice === 'buddy') {
                    targetVoice = enVoices.find(v => v.name.includes('Google UK English Male')) || enVoices.find(v => v.name.includes('Daniel')) || enVoices[1] || enVoices[0];
                } else { 
                     targetVoice = enVoices.find(v => v.name.includes('Zira')) || enVoices.find(v => v.name.includes('Moira')) || enVoices[enVoices.length - 1] || enVoices[0];
                }

                const phrases = text.match(/[^.!?]+[.!?]+|[^.!?]+$/g) || [text];

                phrases.forEach((phrase, index) => {
                    const utterance = new SpeechSynthesisUtterance(phrase.trim());
                    if(targetVoice) utterance.voice = targetVoice;

                    if (selectedVoice === 'star') {
                        utterance.pitch = 1.4; utterance.rate = 1.2;
                    } else if (selectedVoice === 'buddy') {
                        utterance.pitch = 1.0; utterance.rate = 1.0;
                    } else { 
                        utterance.pitch = 0.8; utterance.rate = 0.9;
                    }

                    if (phrase.includes('?')) utterance.pitch += 0.2; 
                    if (phrase.includes('!')) { utterance.rate += 0.1; utterance.volume = 1; } else { utterance.volume = 0.9; }

                    synth.speak(utterance);
                });

            } else {
                alert("Smart Sing not supported on this browser.");
            }
        };

        document.getElementById('export-studio-btn').onclick = () => {
            if(!activeStoryBeat) return;
            
            document.getElementById('stop-story-btn').click();
            document.querySelector('[data-target="view-studio"]').click();
            alert("Beat loaded into Studio! Playing now...");
            
            if(window.studioLoop) clearInterval(window.studioLoop);
            
            let beatIndex = 0;
            window.studioLoop = setInterval(() => {
                if(appActive) {
                    const currentStep = activeStoryBeat[beatIndex % 4];
                    currentStep.forEach(padId => {
                        playPad(pads[padId]);
                        const btn = document.getElementById(`pad-${padId}`);
                        if(btn) {
                            btn.style.borderColor = "white";
                            setTimeout(() => btn.style.borderColor = "rgba(255,255,255,0.1)", 100);
                        }
                    });
                    beatIndex++;
                }
            }, storyTempo);
        };
        
        document.getElementById('clear-beats-btn').onclick = () => {
            if(window.studioLoop) clearInterval(window.studioLoop);
            window.studioLoop = null;
        };

        document.getElementById('stop-story-btn').onclick = () => {
            if(storyInterval) clearInterval(storyInterval);
            storyInterval = null;
            window.speechSynthesis.cancel();
            document.getElementById('story-player').classList.add('hidden');
            document.getElementById('view-story').querySelector('.glass-panel').classList.remove('hidden');
        };

        document.getElementById('stop-all-btn').onclick = () => {
            if(activeSourceNode) activeSourceNode.stop();
            if(storyInterval) clearInterval(storyInterval);
            if(window.studioLoop) clearInterval(window.studioLoop);
            window.speechSynthesis.cancel();
        };

        // --- FIREBASE GALLERY LOGIC ---
        
        function saveToGallery(item) {
            // Adds to Firestore instead of LocalStorage
            db.collection("sonic_gallery").add({
                ...item,
                timestamp: firebase.firestore.FieldValue.serverTimestamp() // For ordering
            })
            .then(() => {
                console.log("Document successfully written!");
                notifyHost('SAVED', item);
            })
            .catch((error) => {
                console.error("Error writing document: ", error);
                alert("Failed to save to cloud. Check console.");
            });
        }

        function initGalleryListener() {
            const list = document.getElementById('gallery-list');
            
            // Listen for updates in real-time
            db.collection("sonic_gallery")
                .orderBy("timestamp", "desc")
                .limit(20)
                .onSnapshot((querySnapshot) => {
                    list.innerHTML = '';
                    if (querySnapshot.empty) {
                        list.innerHTML = `<div class="flex flex-col items-center justify-center h-40 text-slate-500"><span class="text-4xl mb-2">üìÇ</span><p>Gallery is empty.</p></div>`;
                        return;
                    }
                    querySnapshot.forEach((doc) => {
                        const item = doc.data();
                        const div = document.createElement('div');
                        div.className = 'bg-slate-700 p-3 rounded-lg flex justify-between items-center mb-2 animate-fadeIn';
                        div.innerHTML = `<div><div class="font-bold text-sm text-yellow-300">${item.type === 'story' ? 'üìñ' : 'üé§'} ${item.title}</div><div class="text-xs text-slate-400">${item.date}</div></div>`;
                        list.appendChild(div);
                    });
                }, (error) => {
                    console.error("Error getting gallery: ", error);
                    list.innerHTML = `<p class="text-red-400 text-center text-xs">Error loading gallery.</p>`;
                });
        }

        document.getElementById('clear-gallery').onclick = () => { 
            if(confirm("Delete ALL cloud data?")) {
                db.collection("sonic_gallery").get().then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        doc.ref.delete();
                    });
                });
            }
        };

        // Wrappers for buttons
        document.getElementById('save-track-btn').onclick = () => { 
            saveToGallery({type: 'recording', title: "My Cool Track", date: new Date().toLocaleTimeString()}); 
            alert("Saving to Cloud..."); 
        };

    </script>
</body>
</html>